# Инструмент для эмуляции обмена файлами 1С => Битрикс

Этот инструмент полностью эмулирует работу обмена файлами между 1С и Битрикс. Можно обмениваться следующими видами файлов:

* `XML` - стандартный механизм обмена `CommerceML`
* `JSON`, `CSV` - в стандартном механизме такой обмен не предусмотрен, поэтому необходима кастомная доработка PHP-скриптов (см ниже)

Для запуска необходимо указать параметры сайта для обмена и файл. Полученные из файла данные будут загружены на сайт тем же путем, как это делает 1С.

![XML обмен файлами 1С Битрикс offers.xml](https://github.com/dbfun/1c-bitrix-exchange/raw/master/assets/offers.xml.gif)

Минимальный пример запуска через [Docker](https://www.docker.com/):

```
docker  run -it --rm \
        -e SITE=http://site.ru \
        -e AUTH_LOGIN=1c_exchange@site.ru \
        -e AUTH_PASS=password \
        -e FILE_NAME=offers.xml \
        -v $(pwd)/data/offers.xml:/src \
        required/1c-bitrix-exchange:latest
```

Скрипт создан на основе [этого репозитория](https://github.com/dbfun/bitrix-import).

# Установка

## Из реестра Docker Hub

Чтобы получить образ из [реестра Docker Hub](https://hub.docker.com/r/required/1c-bitrix-exchange), откройте командную строку и введите:

```
docker pull required/1c-bitrix-exchange
```

## Из репозитория GitHub

Чтобы собрать образ из репозитория GitHub, введите в терминале:

```
git clone https://github.com/dbfun/1c-bitrix-exchange.git
cd 1c-bitrix-exchange
docker build --tag required/1c-bitrix-exchange .
```

# Конфигурация

## Описание параметров

| Параметр      | Обязательный | Пример значения     | Значение по-умолчанию | Описание                                                                                                                   |
|---------------|--------------|---------------------|-----------------------|----------------------------------------------------------------------------------------------------------------------------|
| SITE          | +            | http://site.ru      |                       | Адрес сайта с протоколом, если хост не резолвится, следует добавить `--dns=IP-вашего-DNS-сервера` в парамерты `docker run` |
| AUTH_LOGIN    | +            | 1c_exchange@site.ru |                       | Логин служебной учетной записи стандартного обмена                                                                         |
| AUTH_PASS     | +            | password            |                       | Пароль служебной учетной записи стандартного обмена                                                                        |
| CHARSET_IN    |              |                     | utf-8                 | Кодировка сайта                                                                                                            |
| CHARSET_OUT   |              |                     | utf-8                 | Кодировка консоли                                                                                                          |
| ZIP           |              | 1                   |                       | Передаваемый файл является архивом, необходимо обработать все файлы из него (указать `1`)                                  |
| GET_STEP_MODE |              | report              |                       | Переменная для кастомного обмена, будет передана как параметр обмена `mode=GET_STEP_MODE`                                  |

## Файл конфигурации

Параметры в скрипт обмена можно передавать через командную строку, но при многократном использовании это делать удобнее через файл конфигурации.

В таком случае нужно скопировать `.env.dist` в `.env` и поправить в нем базовую конфигурацию (адрес сайта, логин-пароль, кодировка).

Тогда запуск обмена станет еще короче:

```
docker  run -it --rm \
        --env-file .env \
        -e FILE_NAME=offers.xml \
        -v $(pwd)/data/offers.xml:/src \
        required/1c-bitrix-exchange:latest
```

# Использование

Каталог `data` создан для удобства хранения файлов для импорта.

Если файл для импорта находится в `data/offers.xml`, команда выглядит так:

```
docker  run -it --rm \
        --env-file .env \
        -e FILE_NAME=offers.xml \
        -e SITE=test.site.ru \
        --dns=10.0.1.1 \
        -v $(pwd)/data/offers.xml:/src \
        -v $(pwd)/log/:/var/log/ \
        required/1c-bitrix-exchange:latest
```

В этом расширенном примере (полужирным - обязательные настройки):

* **`--env-file .env`** - базовые настройки (также настройки можно передать через `-e ПАРАМЕТР=значение`)
* **`-e FILE_NAME=offers.xml`** - имя загружаемоего файла (будет передано в Битрикс как GET-параметр)
* `-e SITE=test.site.ru` - переопределен сайт, указанный в базовых настройках `.env` файла
* `--dns=10.0.1.1` - указан собственный DNS (указывать в случае ошибки `Could not resolve host` для локальных сайтов)
* **`-v $(pwd)/data/offers.xml:/src`** - подмонтировать файл `data/offers.xml` в контейнер для импорта, имя файла может быть любым, но его необходимо указать через `FILE_NAME`
* `-v $(pwd)/log/:/var/log/` - подмонтировать каталог `log/` в контейнер, в нем будут созданы логи обмена (полезно при отладке)

# Кастомная доработка стандартного обмена

Для импорта `JSON`, `CSV` и других типов файлов (в свои отдельные таблицы БД, например) нужно добавить свои кастомные обработчики в стандартный обмен. При этом сохранится стандартный механизм обмена, но появится возможность обработки произвольных файлов.

## 1. Создать собственный компонент

Создадим собственный компонент обмена, для чего скопируем и доработаем стандартный `bitrix:catalog.import.1c`.

```bash
mkdir -p local/components/vendor/
cp -r bitrix/components/bitrix/catalog.import.1c local/components/vendor/
```

Теперь следует поправить скопированный файл `local/components/vendor/catalog.import.1c/component.php`, сниппет с изменениями находится в файле этого репозитория: `snippets/vendor:catalog.import.1c/component.php`.

При вызове можно указать в GET-параметре вместо стандартного режима `mode=import` другое значение, например `mode=report`, и использовать в качестве условия в собственном обработчике: `if(($_GET["..."] == "report")) { /* свой обработчик */ }`.

## 2. Замена вызова компонента

В файле `bitrix/admin/1c_exchange.php` необходимо заменить стандартный компонент на наш:

```php
// заменить
$APPLICATION->IncludeComponent("bitrix:catalog.import.1c"
// на
$APPLICATION->IncludeComponent("vendor:catalog.import.1c"
```

## 3. Тестирование нового обмена

В `docker run` нужно использовать `-e GET_STEP_MODE=custom_mode`, где `custom_mode` - параметр, который будет передан в `$_GET['mode']`.
